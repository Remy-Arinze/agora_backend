trigger:
  - develop

pool:
  name: 'SandboxAgent'

variables:
  azureSubscription: 'agora-current-sc'
  apiAppName: 'agora-api-dev'
  webAppName: 'agora-web-dev'

stages:
# ==========================================================
# STAGE 1: SMART CHANGE DETECTION
# ==========================================================
- stage: CheckChanges
  displayName: 'Analyze Changed Paths'
  jobs:
  - job: Check
    displayName: 'Check Git Diff'
    steps:
    - checkout: self
      fetchDepth: 0 

    - powershell: |
        Write-Host "Checking for changes..."
        try {
            $changes = git diff --name-only origin/develop..HEAD
        } catch {
            Write-Host "Git diff failed, defaulting to DEPLOY ALL."
            $changes = "apps/api apps/web azure-pipelines.yml"
        }
        
        if (-not $changes) {
            $changes = git show --name-only --format= HEAD
        }

        Write-Host "Files changed: $changes"

        $apiChanged = "false"
        $webChanged = "false"

        if ($changes -match "apps/api" -or $changes -match "packages" -or $changes -match "azure-pipelines.yml") {
            $apiChanged = "true"
            Write-Host ">> Detected changes for API."
        }

        if ($changes -match "apps/web" -or $changes -match "packages" -or $changes -match "azure-pipelines.yml") {
            $webChanged = "true"
            Write-Host ">> Detected changes for Web."
        }

        Write-Host "##vso[task.setvariable variable=apiChanged;isOutput=true]$apiChanged"
        Write-Host "##vso[task.setvariable variable=webChanged;isOutput=true]$webChanged"
      name: CheckStep

# ==========================================================
# STAGE 2: BACKEND DEPLOY (API)
# ==========================================================
- stage: Backend
  displayName: 'Deploy Backend (API)'
  dependsOn: CheckChanges
  condition: or(eq(dependencies.CheckChanges.outputs['Check.CheckStep.apiChanged'], 'true'), eq(variables['Build.Reason'], 'Manual'))
  variables:
    workingDir: 'apps/api'
  jobs:
  - job: BuildAndDeployAPI
    steps:
    - task: NodeTool@0
      inputs:
        versionSpec: '20.x'
    
    # 1. Install at ROOT
    - script: npm ci
      workingDirectory: . 
      displayName: 'Install All Dependencies (Root)'

    # 2. Generate Prisma Client
    - script: npx prisma generate --schema=packages/database/prisma/schema.prisma
      workingDirectory: .
      displayName: 'Generate Prisma Client'

    # 3. Force Disable Strict Mode
    - powershell: |
        $path = "$(workingDir)/tsconfig.json"
        if (Test-Path $path) {
            $json = Get-Content $path -Raw | ConvertFrom-Json
            if (-not $json.PSObject.Properties['compilerOptions']) {
                $json | Add-Member -MemberType NoteProperty -Name 'compilerOptions' -Value @{}
            }
            $json.compilerOptions | Add-Member -MemberType NoteProperty -Name "strict" -Value $false -Force
            $json.compilerOptions | Add-Member -MemberType NoteProperty -Name "noImplicitAny" -Value $false -Force
            $json.compilerOptions | Add-Member -MemberType NoteProperty -Name "skipLibCheck" -Value $true -Force
            $json | ConvertTo-Json -Depth 10 | Set-Content $path
            Write-Host "Disabled strict mode in tsconfig.json"
        }
      displayName: 'Disable Strict TypeScript Checks'

    # 4. Build the API
    - script: npm run build
      workingDirectory: $(workingDir)
      displayName: 'Build NestJS'
      env:
        NODE_OPTIONS: '--max-old-space-size=4096'

    # 5. PREPARE DEPLOYMENT ARTIFACTS (Fixes Robocopy Exit Code)
    - powershell: |
        $rootSource = "$(Build.SourcesDirectory)"
        $appDir = "$rootSource/apps/api"
        $buildDist = "$appDir/dist" 
        $deployDir = "$rootSource/deploy_api"
        
        Write-Host "Preparing deployment package at $deployDir..."
        if (Test-Path $deployDir) { Remove-Item $deployDir -Recurse -Force }
        New-Item -ItemType Directory -Force -Path $deployDir | Out-Null

        # A. Copy package.json
        Copy-Item -Path "$appDir/package.json" -Destination $deployDir -Force

        # B. Find Compiled Code (main.js)
        # Search recursively for main.js
        $mainFile = Get-ChildItem -Path "$rootSource" -Filter "main.js" -Recurse | Where-Object { $_.FullName -like "*dist*" } | Select-Object -First 1
        
        if ($mainFile) {
            Write-Host "Found compiled entry point at: $($mainFile.FullName)"
            $sourceDistContent = $mainFile.Directory.FullName
            $targetDist = "$deployDir/dist"
            New-Item -ItemType Directory -Force -Path $targetDist | Out-Null
            
            Write-Host "Copying compiled code..."
            Copy-Item -Path "$sourceDistContent/*" -Destination $targetDist -Recurse -Force
        } else {
            Write-Host "##vso[task.logissue type=error]CRITICAL: Could not find 'main.js' build artifact."
            exit 1
        }

        # C. Copy node_modules (With Exit Code Fix)
        Write-Host "Copying dependencies from Root node_modules..."
        $rootModules = "$rootSource/node_modules"
        $targetModules = "$deployDir/node_modules"
        
        # Robocopy Options:
        # /E = Recursive
        # /MT:8 = Multi-threaded (Fast)
        # /R:0 /W:0 = No retries (Fail fast)
        # /XD .git .cache = Exclude junk folders to prevent loops
        # /NFL /NDL = Quiet mode
        robocopy $rootModules $targetModules /E /MT:8 /R:0 /W:0 /XD .git .cache /NFL /NDL /XO
        
        # --- CRITICAL FIX: Handle Robocopy Exit Codes ---
        # 0 = No files copied (Success)
        # 1 = Files copied successfully (Success)
        # 2-7 = Various success states (Extra files, etc.)
        # 8+ = Actual Failure
        
        if ($LASTEXITCODE -ge 8) { 
            Write-Host "##vso[task.logissue type=error]Robocopy failed with exit code $LASTEXITCODE"
            exit 1
        } else {
            Write-Host "Dependencies copied successfully (Exit code $LASTEXITCODE treated as Success)."
            # Force reset exit code to 0 so pipeline passes
            exit 0
        }

      displayName: 'Assemble Deployment Package'

    # 6. Archive the PREPARED folder
    - task: ArchiveFiles@2
      inputs:
        rootFolderOrFile: '$(Build.SourcesDirectory)/deploy_api'
        includeRootFolder: false
        archiveType: 'zip'
        archiveFile: '$(Build.ArtifactStagingDirectory)/api.zip'
        replaceExistingArchive: true

    - task: AzureWebApp@1
      inputs:
        azureSubscription: $(azureSubscription)
        appType: 'webAppLinux'
        appName: $(apiAppName)
        package: '$(Build.ArtifactStagingDirectory)/api.zip'
        startUpCommand: 'node dist/main'

# ==========================================================
# STAGE 3: FRONTEND DEPLOY (WEB) 
# ==========================================================
- stage: Frontend
  displayName: 'Deploy Frontend'
  dependsOn: CheckChanges
  condition: or(eq(dependencies.CheckChanges.outputs['Check.CheckStep.webChanged'], 'true'), eq(variables['Build.Reason'], 'Manual'))
  variables:
    workingDir: 'apps/web'
  jobs:
  - job: BuildAndDeployWeb
    steps:
    - task: NodeTool@0
      inputs:
        versionSpec: '20.x'

    - script: npm ci
      workingDirectory: $(workingDir)
      displayName: 'Install Dependencies'

    - script: npm run build -- --no-lint
      workingDirectory: $(workingDir)
      displayName: 'Build Next.js App (No Lint)'

    - powershell: |
        Copy-Item -Path "public" -Destination ".next/standalone/apps/web" -Recurse -Force
        New-Item -Path ".next/standalone/apps/web/.next" -ItemType Directory -Force
        Copy-Item -Path ".next/static" -Destination ".next/standalone/apps/web/.next" -Recurse -Force
      workingDirectory: $(workingDir)
      displayName: 'Copy Static Assets to Standalone'

    - task: ArchiveFiles@2
      inputs:
        rootFolderOrFile: '$(workingDir)/.next/standalone' 
        includeRootFolder: false
        archiveType: 'zip'
        archiveFile: '$(Build.ArtifactStagingDirectory)/web.zip'
        replaceExistingArchive: true

    - task: AzureWebApp@1
      inputs:
        azureSubscription: $(azureSubscription)
        appType: 'webAppLinux'
        appName: $(webAppName)
        package: '$(Build.ArtifactStagingDirectory)/web.zip'
        startUpCommand: 'node apps/web/server.js'